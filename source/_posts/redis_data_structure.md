---
title: 【Redis】数据结构
date: 2023-11-19 16:54:29
tags: [Redis, SQL]
math: true
---

## 数据结构

Redis 为什么能这么快
- 内存上的访问非常快
- 归功于它的数据结构

Redis 底层的数据结构一共有 6 种
- 简单动态字符串
- 双向链表 $O(N)$
- 压缩列表 $O(N)$
- 哈希表   $O(1)$
- 跳表     $O(logN)$
- 整数数组 $O(N)$

<!-- more -->

Redis 的数据结构对应的底层结构
- String
  - 简单动态字符串
- List
  - 双向链表
  - 压缩列表
- Hash
  - 压缩列表
  - 哈希表
- Set
  - 哈希表
  - 整数数组
- Sorted Set（zset）
  - 压缩列表
  - 跳表

我们通常把 List, Hash, Set, Sorted Set 称为集合类型，特点是**一个键对应了一个集合的数据**

## 键和值用什么结构组织？

Redis 使用一个哈希表来保存所有的键值对

哈希桶中保存的元素不是值本身，而是指向具体值得指针。

写入大量数据后，可能发现操作变慢了，因为有哈希表的冲突问题和 rehash 可能带来的操作阻塞

Redis 解决哈希冲突的方式，就是链式哈希，同一个哈希桶中的多个元素用一个链表来保存，之间一次用指针连接

哈希冲突越来越多会导致某些哈希冲突链太长，进而导致这个链上的元素查找耗时长、效率降低

所以 Redis 会对哈希表做 rehash 操作，即增加现有的哈希桶的数量，让逐渐增多的 entry 元素能在更多的桶之间分散保存

为了使得 rehash 操作更高效，Redis 默认使用了两个全局哈希表。

rehash 时才为哈希表 2 分配空间，比哈希表 1 更大，而后把哈希表 1 中的数据重新映射并拷贝到哈希表 2 中，释放哈希表 1 的内存

**问题** 看似简单，但是第二步涉及大量的数据拷贝，如果一次性把哈希表 1 中的数据都迁移完，会造成 Redis 线程阻塞，无法服务其他请求，此时 Redis 就无法快速访问数据了

为了避免这个问题，Redis 采用了**渐进式 rehash**

在第二步拷贝数据时，Redis 仍然正常处理客户请求，每处理一个请求，从哈希表 1 中的第一个索引位置开始，顺带着将这个索引位置上所有的 entries 拷贝到哈希表 2 ；等待处理下一个请求时，再顺带拷贝哈希表 1 中的下一个索引位置的 entries。

这样就将一次性大量拷贝的开销，分摊到了多次处理请求的过程中，避免了耗时操作，保证了数据的快速访问

## 集合数据操作效率

与集合的底层数据结构有关，使用哈希表实现的集合，要比使用链表实现的集合访问效率高

其次，操作效率和这些操作本身执行的特点有关，读写一个元素的操作要比读写所有的元素的效率高

## 压缩列表

实际上类似一个数组，数组中的每一个元素都对应保存一个元素，和数组不同的是，压缩列表在表头有三个字段

- zlbytes 列表长度
- zltail 列表尾的偏移量
- zllen 列表中的 entry 个数

在表尾还有一个
- zlend 表示列表的结束

如果我们要定位第一个元素和最后一个元素，可以通过表头三个字段直接定位。而查找其他元素时的复杂度就是 $O(N)$

## 跳表

有序链表只能逐一查找元素，操作起来非常缓慢，跳表在链表的基础上增加了多级索引，通过索引位置的几个跳转，实现数据的快速定位

当数据量很大时，跳表的查找复杂度就是 $O(logN)$

## 不同操作的复杂度

集合类型的操作类型很多
- 读写单个集合元素
- 操作多个元素
- 对整个集合进行遍历操作

用于快速记住集合常见操作的口诀

- 单元素操作是基础
- 范围操作非常耗时
- 统计操作通常高效
- 例外情况只有几个

### 单元素操作

Hash 类型的
- HGET 获取哈希表中指定字段的值
- HSET 设置哈希表中指定字段的值
- HDEL 删除哈希表中一个或多个字段
- HMSET O(M) 同时设置多个字段的值
- HMGET O(M) 获取哈希表中多个字段的值

Set 类型的（哈希表作为底层结构时）
- SADD 向集合添加一个或多个成员
- SREM 从集合中移除一个或多个成员
- SRANDMEMBER 从集合中随机获取一个或多个成员

### 范围操作

Hash 类型的
- HGETALL 获取哈希表中所有字段和值

Set 类型的
- SMEMBERS 获取集合中的所有成员

List类型的
- LRANGE 获取列表中指定范围内的元素

ZSet类型的
- ZRANGE 获取有序集合中指定范围内的成员

但是 Redis 从 2.8 版本开始提供 SCAN 系列操作（HSCAN, SSCAN, ZSCAN），这种渐进式遍历的方式可以更好地处理大型数据集，减少对服务器资源的压力，并在不阻塞 Redis 的同时允许客户端对数据集进行操作。

### 统计操作

集合类型对集合中所有元素个数的记录
- LLEN 获取列表的长度
- SCARD 获取集合的基数（即集合中元素的数量）

复杂度只有 $O(1)$

### 例外情况

压缩列表和双向链表都会记录表头和表尾的偏移量

对 List 类型的 LPOP, RPOP, LPUSH, RPUSH 这四个操作来说，可以通过偏移量直接定位，复杂度只有 $O(1)$