---
title: 【Redis】哨兵机制
date: 2023-11-28 19:14:34
tags: [Redis, SQL]
---

按照主从库模式规定，如果是读请求，还可以由从库继续提供服务，一旦有写请求了，按照主从库模式下读写分离要求，需要由主库来完成

## 如果主库挂了

- 主库真的挂了吗
- 该选择哪个从库作为主库
- 怎么把新主库的相关信息通知给从库和客户端

哨兵机制，是实现主从库自动切换的关键机制，有效地解决了以上三个问题

## 哨兵机制的基本流程

哨兵其实就是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行

主要负责三个任务：监控、选主和通知

### 监控

哨兵进程在运行时，周期性地给所有的主从库发送 ping 命令，检测它们是否在线

如果从库没有在规定时间内响应哨兵的 ping 命令，哨兵会将其标记为‘下线状态’

如果主库也没有在规定时间内响应哨兵，哨兵就会判定主库下线，然后开始自动切换主库的流程

### 主观下线和客观下线


哨兵进程会使用 ping 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态

如果发现主库或者从库响应超时了，那么哨兵会先将其标记为‘主观下线’

如果检测是主库，那么还需要以防是哨兵的误判，一旦启动了主从切换，后续的选主和通知操作都会带来额外的计算和通信开销

误判一般会发生在集群网络压力较大、网络拥塞或者主库本身压力较大的情况下

哨兵机制通常会采用多实例组成的集群模式进行部署，也被称之为哨兵集群

引入多个哨兵实例一起决策，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况

**客观下线的标准**就是当有 N 个哨兵实例时，最好要有 N / 2 + 1 个实例判断主库为主观下线

这样才能最终判定主库为‘客观下线’就可以减少误判的概率，也能避免误判带来的无谓的主从库切换

## 如何选定新主库

选择新主库的过程称为“筛选 + 打分”

先按照**一定的筛选条件**把不符合条件的从库去掉，然后按照**一定的规则**给剩下的从库逐个打分，将得分最高的选为新主库

**除了要检查从库的当前在线状态，还要判断它之前的网络连接状态**

如果从库总是和主库断连，并且超出了一定的阈值，我们就可以把这个筛选掉

具体可以使用配置项 down-after-milliseconds * 10

down-after-milliseconds 是我们认定主从库断连的最大连接超时时间

如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库

接下来给剩下的从库**打分**

分别按照三个规则依次进行三轮打分

- 从库优先级

用户可以通过 slave-priority 配置项给不同的从库设置不同的优先级

如果有一个从库优先级最高，那它就是新主库

如果优先级都一样，那么开始第二轮打分

- 从库复制进度

和旧主库同步程度最接近的从库得分高

判断依据：slave_repl_offset 需要最接近 master_repl_offset

- 从库 ID 号

ID 号小的从库得分高

