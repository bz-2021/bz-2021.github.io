---
title: 【Redis】AOF 日志
date: 2023-11-20 18:47:17
tags: [Redis, SQL]
---

## Redis 持久化的两大机制

Redis 将数据存储在内存中，**一旦服务器宕机，内存中的数据将全部丢失**

对 Redis 来说，实现数据的持久化，避免从后端数据库中进行恢复，是至关重要的

Redis 的持久化主要有两大机制，即 AOF 日志和 RDB 快照

## AOF 日志是如何实现的

我们比较熟悉的是数据库的写前日志（WAL）

在实际写数据之前，先把修改的数据记到日志文件中，以便故障时进行恢复

AOF 正好相反，是写后日志，Redis 先执行命令，然后才记录日志

传统数据库的日志，例如 redo log 记录的是修改后的数据，而 AOF 记录的是 Redis 收到的每一条命令

### 为什么要后记录日志呢？

为了避免检查的开销，Redis 在 向 AOF 写入日志的时候，并不会进行语法检查，使用日志恢复数据时，可能会出错

采用后写日志，只有能执行成功才会写入到日志，而且不会阻塞当前的写操作

### 潜在风险

执行完一条命令后还没来得及记日志就宕机了，那么就会有数据丢失的风险

如果 Redis 时用做缓存，那么还可以从后端数据库重新读入数据进行恢复

如果直接用作数据库，那就无法进行恢复了

其次，虽然避免了对当前命令的阻塞，但可能会对下一个操作带来阻塞风险，因为 AOF 日志也是在主进程中执行的

为了解决这些问题，需要控制一个写命令执行完后 AOF 日志写回磁盘的时机

### 三种写回策略

AOF 配置项中 appendfsync 提供了三个选项

- always 同步写回
  - 可靠性高，但是不可避免地会影响主线程性能
- Everysec 日志写到 AOF 日志的内存缓冲区，每秒写回
  - 性能适中，避免了“同步写回”的性能开销，但是发生宕机，未落盘的日志仍然会丢失
- No 由操作系统决定何时将缓冲区内容写回磁盘
  - 性能好，但是落盘的时机不在 Redis 手中，宕机时丢失数据较多

### AOF 日志文件太大 与 AOF 重写

- 文件系统本身对文件大小有限制
- 文件过大，追加日志效率也会变低
- 恢复过程缓慢

进行日志的重写：根据这个键值对最新的状态，为它生成对应的写入命令

重写过程是由后台线程 bgrewriteaof 来完成的，为了避免阻塞主线程

重写的过程总结为：**“一个拷贝，两处日志”**

一个拷贝：执行重写时，主线程 fork 出后台的子进程，会把主内存拷贝给子线程

两处日志：两处日志分别是一处正在使用的AOF日志，另一处是新的AOF重写日志