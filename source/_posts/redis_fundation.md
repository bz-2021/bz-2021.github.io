---
title: 【Redis】基础架构
date: 2023-05-22 11:17:00
tags: [Redis, SQL]
---


本文是我在阅读[GeekTime《Redis核心技术与实战》](https://time.geekbang.org/column/intro/100056701)时的笔记，侵删。

## Redis 的持久化方式 RDB 和 AOF 的区别：

使用 Redis 作为缓存，方便多个业务进程之间共享数据，Redis 提供两种方式进行持久化。

<!-- more-->

一种是 RDB 持久化，原理是将 Redis 在内存中的数据库记录定时 dump 到磁盘的 RDB 持久化。

另一种是 AOF 持久化，原理是将 Redis 的操作日志以追加的方式写入文件。

二者的区别：

RDB 持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是 fork 一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。

AOF 持久化以日志的形式记录服务器所处理的写入、删除操作，以文本的方式记录，可以打开文件看到详细的操作记录。

在高并发场景下，这会直接带来两个新问题：写 AOF 和 RDB 会造成 Redis 性能抖动；Redis 集群数据同步和实例恢复时，读 RDB 比较慢，限制了同步和恢复速度。

## 系统观是至关重要的

对于单线程的 Redis 而言，任何阻塞性的操作都会导致长尾延迟的产生，开始寻找可能导致阻塞的关键因素，一开始想到是网络阻塞，但随着对 Redis 的理解，知道了 Redis 网络 IO 使用 IO 复用机制，并不会阻塞在单个客户端上。

IO 多路复用：一种同步 IO 模型，实现一个进程可以监视多个文件的句柄。

一旦某个文件的句柄就绪，就能通知应用程序进行相应的读写操作。

没有文件句就绪就会阻塞应用程序，交出CPU。

而后又把目光转向了键值对数据结构、持久化机制下的Fork调用、主从库同步时的AOF重写，以及缓冲区溢出等多个方面，这样一来便系统地掌握了影响Redis性能的关键因素路径。

## 所谓的 Redis 知识全景图都包括什么？

简单来说就是“两大维度，三大主线”

应用维度分为：缓存应用、集群应用、数据结构应用

系统维度分为：处理层、内存层、存储层、网络层

其中处理层有线程模型、组从复制、数据分片

内存层有数据结构、哨兵机制

存储层有 AOF、RDB、负载均衡

网络层有 epoll 网络模型

其中线程模型、数据结构、AOF、epoll在高性能主线，主从复制、哨兵机制、RDB在高可靠机制，数据分片、负载均衡在高扩展主线。

裂解Redis的各项关键技术的设计原理能够为你的判断和推理问题打下坚实的基础，还能从总掌握一些优雅的系统设计规范。

比如run-to-complete模型、epoll网络模型

我们按照三大主线进行体系的学习：高性能主线、高可靠主线、高可扩展主线。

基础篇：简单的键值数据库入手，具体讲解数据结构、线程模型、持久化等。

实践篇：以场景和案例作为驱动，数据结构的合理使用，缓存和集群的两大场景。

未来篇：Redis 6.0增加了多线程等新特性

## 基础架构

首先对Redis进行总体架构和关键模块的全局认识，然后深入到具体的技术点。

**SimpleKV**

一个用户ID对应一个用户信息集合，这是键值数据库的一种**数据模型**。

支持的三种基本的**数据操作**：GET、PUT、DELETE

有些键值数据库得新写/更新操作叫做 SET

在实际得业务场景中，还会碰到：查询一个用户在一段时间内的访问记录。根据一段 key 的范围返回相应的 value 值，这是 SCAN 操作

非常重要的设计问题：键值对保存在内存还是外存？

考虑主要的应用场景：缓存场景下的数据要快速访问但允许丢失。

大体来说，一个键值数据库包括**访问框架**、**索引模块**、**操作模块**和**存储模块**四部分

采用什么访问模式：

- 通过函数库调用的方式供外部应用使用，以动态链接库的形式链接到我们自己的程序中，提供键值存储功能。
- 另一种通过网络框架Socket通信的形式对外提供键值对操作。

键值数据库网络框架接收到网络包，并按照相应的协议进行解析，开始实际的写入流程，我们会遇到系统设计上的问题：

网络连接的处理、网络请求的解析、数据存取的处理，用一个线程、多个线程、还是多个进程交互处理呢？

我们一般称这个问题为 I/O 模型设计

单线程可能会发生阻塞，多线程又会发生线程竞争，影响系统效率，Redis是如何做到单线程、高效率的？？

## 如何定位键值对的位置

依赖于键值数据库的索引模块

索引的类型有很多
- 哈希表
- B+树
- 字典树
- 跳表

一般而言，内存键值数据库（例如 Redis）采用哈希表作为索引，因为内存的高性能随机访问特性可以很好地和哈希表O（1）的操作复杂度相匹配

Redis 的 value 支持多种类型，在通过索引找到一个 key 对应的 value 后， 仍然需要从 value 的复杂结构中进一步找到我们实际需要的数据，这个操作的效率本身就依赖于它们的实现结构。

## 实现重启后快速提供服务

在存储模块中增加持久化功能

一种方式是：对于每一个键值对，都对其进行落盘保存，每次都要写盘，性能会受很大影响

另一种方式：周期性地把内存中的键值对保存到文件中，潜在的代价是数据有丢失的风险